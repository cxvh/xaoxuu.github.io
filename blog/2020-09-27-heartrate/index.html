<!DOCTYPE html><html lang="zh-CN"><head hexo-theme="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.0.0-rc.1"><meta charset="utf-8"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>如何使用手机摄像头测量心率 - XAOXUU</title><meta name="keywords" content="iOS,心率"><meta name="description" content="在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。"><meta property="og:title" content="如何使用手机摄像头测量心率 - XAOXUU"><meta property="og:description" content="在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。"><meta property="og:locale" content="zh_CN"><meta property="og:url" content="https://xaoxuu.com/blog/2020-09-27-heartrate/"><meta property="og:type" content="website"><meta property="og:site_name" content="XAOXUU"><meta property="og:image" content="https://7.dusays.com/2021/02/17/a571e3981f0b2.svg"><link rel="alternate" href="/atom.xml" title="XAOXUU" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css"><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png"><link rel="manifest" href="/assets/favicon/site.webmanifest"><link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="/assets/favicon/favicon.ico"><meta name="msapplication-TileColor" content="#2d89ef"><meta name="msapplication-config" content="/assets/favicon/browserconfig.xml"><meta name="theme-color" content="#ffffff"></head><body theme="light"><div class="l_body" id="start"><aside class="l_left"><div class="wrap"><header class="header"><div class="logo-wrap"><a href="/"><div class="img"><img no-lazy src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png"></div><span class="title">XAOXUU</span></a></div><nav class="menu"><a class="nav-item active" href="/"><span>文章</span></a> <a class="nav-item" href="/wiki/"><span>项目</span></a> <a class="nav-item" href="/friends/"><span>友链</span></a> <a class="nav-item" href="/about/"><span>关于</span></a></nav></header><div class="widgets"><div class="widget-wrap" id="toc"><div class="widget-header dis-select"><span class="name">本文目录</span> <a class="cap-action" id="s-top" title="回到顶部" href="#start"><svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10505"><path d="M884.526 163.323H208.881c-30.516 0-55.25 24.934-55.25 55.685s24.734 55.685 55.25 55.685h675.645c30.515 0 55.255-24.93 55.255-55.685s-24.74-55.685-55.255-55.685zM568.253 336.87a56.765 56.765 0 0 0-4.06-3.701c-.63-.517-1.29-.968-1.935-1.454-.799-.605-1.577-1.224-2.406-1.787-.779-.528-1.583-.978-2.386-1.46-.748-.45-1.485-.926-2.253-1.341-.81-.44-1.649-.814-2.483-1.208-.8-.384-1.588-.784-2.407-1.132-.814-.338-1.643-.61-2.463-.906-.875-.323-1.745-.66-2.641-.932-.825-.25-1.66-.435-2.489-.645-.916-.236-1.817-.492-2.75-.681-.962-.19-1.935-.307-2.902-.445-.814-.118-1.618-.272-2.442-.354a55.163 55.163 0 0 0-5.438-.276h-.015c-.267 0-.528.036-.794.036a54.856 54.856 0 0 0-39.86 16.271l-279.413 281.61c-21.576 21.75-21.576 57.006 0 78.756a54.876 54.876 0 0 0 39.07 16.312 54.835 54.835 0 0 0 39.066-16.312l186.67-188.145V898.09c0 30.75 24.74 55.685 55.256 55.685s55.255-24.934 55.255-55.685v-387.42L769.526 697.22a54.871 54.871 0 0 0 39.065 16.312 54.835 54.835 0 0 0 39.066-16.312c21.576-21.75 21.576-57.006 0-78.756L568.253 336.87z" p-id="10506"></path></svg></a></div><div class="widget-body post"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E7%94%B5%E5%AE%B9%E7%A7%AF%E8%84%89%E6%90%8F%E6%B3%A2%E6%8F%8F%E8%AE%B0%E6%B3%95"><span class="toc-text">光电容积脉搏波描记法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86"><span class="toc-text">信号处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%89%E5%86%B2%E6%8E%A2%E6%B5%8B%E5%99%A8"><span class="toc-text">脉冲探测器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%84%89%E7%8E%87"><span class="toc-text">计算脉率</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E7%A1%AE%E6%80%A7%E4%B8%8E%E5%8F%82%E8%80%83%E4%BB%B7%E5%80%BC"><span class="toc-text">准确性与参考价值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%89%E7%8E%87%E5%92%8C%E5%BF%83%E7%8E%87"><span class="toc-text">脉率和心率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">后记</span></a></li></ol></div></div></div><div class="widget-wrap" id="recent"><div class="widget-header dis-select"><span class="name">最近更新</span> <a class="cap-action" id="rss" title="Subscribe" href="/atom.xml"><svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8938"><path d="M800.966 947.251c0-404.522-320.872-732.448-716.69-732.448V62.785c477.972 0 865.44 395.987 865.44 884.466h-148.75zm-162.273 0h-148.74c0-228.98-181.628-414.598-405.678-414.598v-152.01c306.205 0 554.418 253.68 554.418 566.608zm-446.24-221.12c59.748 0 108.189 49.503 108.189 110.557 0 61.063-48.44 110.563-108.188 110.563-59.747 0-108.18-49.5-108.18-110.563 0-61.054 48.433-110.556 108.18-110.556z" p-id="8939"></path></svg></a></div><div class="widget-body"><div class="post-title"><a href="/blog/2020-08-23-issues-api/">静态博客使用 Issues API 动态发布友链、书签</a></div><div class="post-title"><a href="/blog/2019-10-06-ios-apple-watch/">苹果设计开发加速器《创建卓越的 Apple Watch 体验》活动体验</a></div><div class="post-title"><a href="/blog/2021-01-02-shell/">如何搭建一个脚本库，直接调用云端脚本</a></div><div class="post-title"><a href="/blog/2020-09-27-heartrate/">如何使用手机摄像头测量心率</a></div><div class="post-title"><a href="/blog/2020-11-19-ios-layout/">苹果线上活动《为 iPhone 和 iPad 搭建灵活适配的用户界面》</a></div></div></div></div><footer class="footer"><div class="social-wrap"><a class="social" href="/atom.xml"><img src="https://7.dusays.com/2021/02/14/25678f144c438.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/14/25678f144c438.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></a><a class="social" target="_blank" rel="noopener" href="https://github.com/xaoxuu"><img src="https://7.dusays.com/2021/02/14/08a41b181ce68.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/14/08a41b181ce68.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></a><a class="social" target="_blank" rel="noopener" href="https://music.163.com/#/user/home?id=63035382"><img src="https://7.dusays.com/2021/02/14/cf1ae151f9e83.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/14/cf1ae151f9e83.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></a><a class="social" href="/comments/"><img src="https://7.dusays.com/2021/02/14/942ebbf1a4b91.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/14/942ebbf1a4b91.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></a></div></footer></div></aside><div class="l_main"><div class="breadcrumb-navigation"><div class="cap"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span> <a class="cap breadcrumb" href="/">文章</a><span class="sep"></span> <a class="cap breadcrumb cat-link" href="/blog/categories/%E8%AE%BE%E8%AE%A1%E5%BC%80%E5%8F%91/">设计开发</a></div><div><time>2020年9月27日</time></div></div><article class="content md post reveal"><h1 class="article-title"><span>如何使用手机摄像头测量心率</span></h1><p>在心率管家默默无闻地上线了一年多之后，现在终于打算来好好聊聊关于手机摄像头测量心率的那些事。本文参考了很多前辈的文章，将在文末列出。</p><a id="more"></a><div class="tag-plugin video-wrap"><div class="frame-wrap" id="iphone11" focus="top"><video poster="https://7.dusays.com/2020/09/28/baa33914a34ec.jpg" playsinline="" muted loop autoplay preload="metadata"><source src="https://7.dusays.com/2020/09/28/39db723f1e200.mp4" type="video/mp4"></video><div class="frame"></div></div></div><h2 id="光电容积脉搏波描记法"><a href="#光电容积脉搏波描记法" class="headerlink" title="光电容积脉搏波描记法"></a>光电容积脉搏波描记法</h2><p>目前市面上大部分便携心率检测设备都是基于光电容积脉搏波描记法来测量的。由于心跳引起动脉周期性变化，动脉内血液的容积发生周期性变化，因而对光线的吸收也会呈现同样的周期性变化，这个周期性变化的频率就是脉率，脉率大部分情况都和心率一致。</p><p>打开相机，把手指指尖覆盖在摄像头上，观察屏幕上的取景框，就可以发现每心跳一次，屏幕中的红色都会变暗一次。对每一帧画面提取 RGB 均值，并转换到 HSV 色彩空间，把色相 H 作为特征值，得到时域信号。</p><h2 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h2><p>我使用简单的时域分析法计算脉率，关键点就是计算采样时间内的波峰个数。把色相信号绘制波形图如下：</p><div class="tag-plugin img-wrap"><div class="img-bg" style="background:#fff"><img class="img lazyload" src="https://gitee.com/xaoxuu/cdn-assets/raw/master/blog/2020-0927a@2x.jpg" class="lazyload" data-srcset="https://gitee.com/xaoxuu/cdn-assets/raw/master/blog/2020-0927a@2x.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="width:300px;padding:8px"></div></div><p>由于覆盖力度不稳定导致色相会整体偏移因而产生低频噪声，再加原本就存在的高频噪声影响，波形显得很杂乱无章，所以使用带通递归滤波器进行滤波：</p><p><img src="https://7.dusays.com/2020/09/27/5ac0064c05e2d.svg" class="lazyload" data-srcset="https://7.dusays.com/2020/09/27/5ac0064c05e2d.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>公式展开为：</p><p><img src="https://7.dusays.com/2020/09/27/8eb5058d3577f.svg" class="lazyload" data-srcset="https://7.dusays.com/2020/09/27/8eb5058d3577f.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>用 Swift 语言实现这个滤波器的算法（10阶）为：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">struct</span> <span class="title">BandpassFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> x = [<span class="type">CGFloat</span>].<span class="keyword">init</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: <span class="number">11</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> y = [<span class="type">CGFloat</span>].<span class="keyword">init</span>(repeating: <span class="number">0</span>, <span class="built_in">count</span>: <span class="number">11</span>)</span><br><span class="line">    <span class="meta">@discardableResult</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">filted</span><span class="params">(<span class="number">_</span> value: CGFloat)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> x.<span class="built_in">count</span> &gt; <span class="number">10</span>, y.<span class="built_in">count</span> &gt; <span class="number">10</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="number">10</span> &#123;</span><br><span class="line">            x[i] = x[i+<span class="number">1</span>]</span><br><span class="line">            y[i] = y[i+<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        x[<span class="number">10</span>] = value / <span class="number">1.894427025e</span>+<span class="number">01</span></span><br><span class="line">        y[<span class="number">10</span>] = x[<span class="number">10</span>] - x[<span class="number">0</span>] + <span class="number">5</span> * (x[<span class="number">2</span>] - x[<span class="number">8</span>]) + <span class="number">10</span> * (x[<span class="number">6</span>] - x[<span class="number">4</span>])</span><br><span class="line">        y[<span class="number">10</span>] += (-<span class="number">0.0000000000</span> * y[<span class="number">0</span>]) + (<span class="number">0.0357796363</span> * y[<span class="number">1</span>])</span><br><span class="line">        y[<span class="number">10</span>] += (-<span class="number">0.1476158522</span> * y[<span class="number">2</span>]) + (<span class="number">0.3992561394</span> * y[<span class="number">3</span>])</span><br><span class="line">        y[<span class="number">10</span>] += (-<span class="number">1.1743136181</span> * y[<span class="number">4</span>]) + (<span class="number">2.4692165842</span> * y[<span class="number">5</span>])</span><br><span class="line">        y[<span class="number">10</span>] += (-<span class="number">3.3820859632</span> * y[<span class="number">6</span>]) + (<span class="number">3.9628972812</span> * y[<span class="number">7</span>])</span><br><span class="line">        y[<span class="number">10</span>] += (-<span class="number">4.3832594900</span> * y[<span class="number">8</span>]) + (<span class="number">3.2101976096</span> * y[<span class="number">9</span>])</span><br><span class="line">        <span class="keyword">return</span> y[<span class="number">10</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个算法是从 <a target="_blank" rel="noopener" href="https://github.com/WuXiaoTu/HeartRate">WuXiaoTu/HeartRate</a> 这个开源库中翻译来的，由于滤波效果已经满足需求了，我就没有去修改滤波参数。</p></blockquote><p>经过滤波之后就能看到波形图呈现锯齿状，由于这是由摄像头捕捉到的色相的波形图，所以看起来并不会像心电图那样：</p><div class="tag-plugin img-wrap"><div class="img-bg" style="background:#fff"><img class="img lazyload" src="https://gitee.com/xaoxuu/cdn-assets/raw/master/blog/2020-0927b@2x.jpg" class="lazyload" data-srcset="https://gitee.com/xaoxuu/cdn-assets/raw/master/blog/2020-0927b@2x.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="width:300px;padding:8px"></div></div><p>有了干净的波形图，就可以数出一段时间内的波峰个数，从而计算出频率。例如数5秒内有多少个波峰，然后乘以12就是每分钟脉搏跳动次数，也就是这5秒内的平均脉率。现在 GitHub 上的很多同类的开源项目也都是这种方案。由于连续测量的时间越长，发生中断的可能性就越大，测量成功率就越低，再考虑到心率本身就是变化的，时间跨度太长也会使得数据变得没有意义，测量时间太短又很容易被个别误差数据影响。</p><p>网络上现有方案都是先确定测量时长，时间结束后计算结果：</p><ul><li>如果测量时间短：成功率高，准确性低。</li><li>如果测量时间中等：成功率低，准确性高。</li><li>如果测量时间长：成功率很低，准确性很高，但是数据意义不大。</li></ul><p>我想出了一种新的方案，就是每探测到一个有效脉冲，就记录下这个脉冲与上一个有效脉冲之间的间隔，两个连续的有效脉冲计算出来的频率就是100%正确的瞬时脉率。所以改进后的方案是：开始测量后，始终记录脉冲，随时可以计算瞬时脉率、最后若干秒的平均脉率。</p><ul><li>成功率：100%（不存在测量中断而失败的情况）</li><li>准确性的情况如下：<ul><li>如果脉冲计数都是由脉搏跳动引起的，测量结果就是完全准确的</li><li>如果脉搏跳动了而脉冲计数没有增加，不会影响结果，因为计算时只会把有效脉冲的周期进行累加</li><li>如果在脉搏跳动间隙额外增加了脉冲计数，那么数据就会失真</li></ul></li></ul><p>如果不故意快速抖动手指，数据失真的情况就不会发生，因为手指不离开摄像头并在两次脉搏跳动中间产生一次色相饱和度明度都以假乱真的脉冲信号是很难的。</p><h3 id="脉冲探测器"><a href="#脉冲探测器" class="headerlink" title="脉冲探测器"></a>脉冲探测器</h3><p>经过滤波后的数值是围绕0上下波动的，分别记录大于0的值和小于0的值，各自保存到数组中，然后求出它们的平均值：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> filted &gt; <span class="number">0</span> &#123;</span><br><span class="line">    upVals.append(filted)</span><br><span class="line">    <span class="keyword">if</span> upVals.<span class="built_in">count</span> &gt; <span class="number">20</span> &#123;</span><br><span class="line">        upVals.removeFirst(upVals.<span class="built_in">count</span> - <span class="number">20</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> filted &lt; <span class="number">0</span> &#123;</span><br><span class="line">    downVals.append(filted)</span><br><span class="line">    <span class="keyword">if</span> downVals.<span class="built_in">count</span> &gt; <span class="number">20</span> &#123;</span><br><span class="line">        downVals.removeFirst(downVals.<span class="built_in">count</span> - <span class="number">20</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> avgUp = upVals.<span class="built_in">reduce</span>(<span class="number">0</span>, +) / <span class="type">CGFloat</span>(upVals.<span class="built_in">count</span>)</span><br><span class="line"><span class="keyword">let</span> avgDown = downVals.<span class="built_in">reduce</span>(<span class="number">0</span>, +) / <span class="type">CGFloat</span>(downVals.<span class="built_in">count</span>)</span><br></pre></td></tr></table></figure><p>如果新的值高于 <code>avgUp</code> 的一半，就标记 <code>flag = true</code> ，低于 <code>avgDown</code> 的一半且 <code>flag = true</code> 就标记 <code>flag = true</code>，触发一次脉冲，记录下这个脉冲的时间戳。如果两个脉冲之间的时间间隔符合正常心率的范围，就认为是有效脉冲。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> filted &gt; <span class="number">0.5</span> * avgUp  &#123;</span><br><span class="line">    flag = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> filted &lt; <span class="number">0.5</span> * avgDown &amp;&amp; flag == <span class="literal">true</span> &#123;</span><br><span class="line">    flag = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> time = <span class="type">CACurrentMediaTime</span>()</span><br><span class="line">    <span class="keyword">let</span> period = time - periodStart</span><br><span class="line">    <span class="comment">// 与上一个周期间隔时间满足正常周期范围</span></span><br><span class="line">    <span class="keyword">if</span> period &lt; <span class="type">MAX_PERIOD</span> &amp;&amp; period &gt; <span class="type">MIN_PERIOD</span> &#123;</span><br><span class="line">        <span class="comment">// 记录这次脉冲与上次脉冲的时间间隔</span></span><br><span class="line">        periods.append(period)</span><br><span class="line">        <span class="comment">// 捕获到脉冲</span></span><br><span class="line">        delegate?.pulseDetector(detector: <span class="keyword">self</span>, capture: periods)</span><br><span class="line">    &#125;</span><br><span class="line">    periodStart = time</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> filted</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上文「正常心率的范围」如何界定？心率如果低到 40bpm 此时周期达到最大值，如果心率高达 255bpm 则周期达到最小值。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">MAX_PERIOD</span> = <span class="type">CFTimeInterval</span>(<span class="number">60.0</span> / <span class="number">40</span>)</span><br><span class="line"><span class="type">MIN_PERIOD</span> = <span class="type">CFTimeInterval</span>(<span class="number">60.0</span> / <span class="number">255</span>)</span><br></pre></td></tr></table></figure><h3 id="计算脉率"><a href="#计算脉率" class="headerlink" title="计算脉率"></a>计算脉率</h3><p>上一步记录下了每个脉冲的周期，取出最后 N 个要计算的脉冲，把它们的周期相加就是总时长，用 <code>个数 / 时长</code> 计算的值就是频率，频率乘以 <code>60</code> 就是每分钟的脉冲数，也就是脉率。</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcFrequency</span><span class="params">(<span class="built_in">count</span>: Int)</span></span> -&gt; <span class="type">CGFloat?</span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> (<span class="number">0</span> ... periods.<span class="built_in">count</span>).<span class="built_in">contains</span>(<span class="built_in">count</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> duration = periods.<span class="built_in">dropFirst</span>(periods.<span class="built_in">count</span> - <span class="built_in">count</span>).<span class="built_in">reduce</span>(<span class="number">0</span>, +)</span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGFloat</span>(<span class="built_in">count</span>) / <span class="type">CGFloat</span>(duration)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tag-plugin img-wrap"><div class="frame-wrap" id="iphone11"><img class="img lazyload" src="https://7.dusays.com/2020/09/27/b933c68476fa8.png" class="lazyload" data-srcset="https://7.dusays.com/2020/09/27/b933c68476fa8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="><div class="frame"></div></div></div><h2 id="准确性与参考价值"><a href="#准确性与参考价值" class="headerlink" title="准确性与参考价值"></a>准确性与参考价值</h2><p>由于心率是动态变化的，即使测量的脉搏跳动都是准确的，也就是说测量阶段实现了零误差，但是计算方式不一样也会产生不同的结果。因此直接拿结果去和小米手环或者 Apple Watch 上显示的数值去进行对比是不严谨的。正确地方法是在一个时间段内用多种方式测量的同时亲自用手测量脉搏跳动次数，可以借助本文的 demo 计算瞬时或者平均脉率，如果一段时间的脉冲计数完全正确，那么 demo 计算的结果就是完全准确的，瞬时脉率、最后 N 秒的平均脉率一般都不会相同。因此即使戴在一只手上同一时间进行测量，不同产品显示的心率不同也并不能说明它们谁更准，只能说谁的结果更具有参考价值。</p><p>对此，我优化后的心率管家测量方案可以选择测量时长，也可以随时结束测量，运动后心率变化快的时候适合取短时间内例如5s平均脉率，心平气和的时候可以取适当长一点的例如10s或者20s的平均脉率。</p><h2 id="脉率和心率"><a href="#脉率和心率" class="headerlink" title="脉率和心率"></a>脉率和心率</h2><p>脉率是每分钟脉搏的次数，心率是每分钟心跳次数，健康情况下脉率与心率一致，但是如果出现心律失常，心脏有一些跳动不能有效将血液泵至全身，因此会出现脉搏缺失，导致脉率显著低于心率。如果用来判断心脏功能状态，误差很大。对于心动过速、低血压症和休克病人，即使是心率规则，由于脉压差很小，脉搏也会很弱，此时往往不能够准确测量脉率。</p><p>另外，脉搏随肢体移动会形成伪迹波动，也会影响脉率的测量。而心率不受心律失常、心动过速、休克、肢体活动的影响，所以在临床上，医生判断心跳活动不是看脉率，而是看心率，摸脉搏只是一个辅助操作。</p><p>因此，通过手环、手表、app 测量的“心率”并不是一个完全可靠的数据。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>非常感谢 <a target="_blank" rel="noopener" href="https://lifestyle1.cn/">@JustinYang</a> 大佬在滤波算法方面给予的援助。也十分感谢 <a target="_blank" rel="noopener" href="https://punmy.cn/">@Punmy</a>、<a target="_blank" rel="noopener" href="https://github.com/WuXiaoTu">@WuXiaoTu</a> 等作者的文章，使得后人能够少走很多弯路。</p><div class="tag-plugin tag link"><a class="link-card" title="心率管家&nbsp;App&nbsp;的设计与开发流程" href="/blog/2019-07-23-heartmate/"><div class="left"><span class="title">心率管家&nbsp;App&nbsp;的设计与开发流程</span><span class="url">/blog/2019-07-23-heartmate/</span></div><div class="right"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></div></a></div></article><div class="references-wrap"><section class="header"><span>参考资料</span></section><section class="body"><ul><li class="post-title"><a target="_blank" rel="noopener" href="https://punmy.cn/2016/07/28/15231176397746.html">心跳之旅—💗—iOS用手机摄像头检测心率(PPG)</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/695c131abfa5">PPG光电容积脉搏波描记法技术概况</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://blog.csdn.net/shengzhadon/article/details/46803401">数字信号处理公式变程序（四）——巴特沃斯滤波器（下）</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9f678e0bdf9b">iOS手机摄像头测心率</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/27391584">各种智能手表/智能手环的心率监测功能精准度怎么样？都有哪些技术在里面？</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://github.com/WuXiaoTu/HeartRate">通过手机摄像头获取心率值</a></li><li class="post-title"><a target="_blank" rel="noopener" href="https://www.latexlive.com">LaTeX公式编辑器</a></li></ul></section></div><div class="read-next-wrap"><section class="header cap cyan"><span>接下来阅读</span></section><section class="body"><div class="post-title unread"><a href="/blog/2020-11-19-ios-layout/">苹果线上活动《为 iPhone 和 iPad 搭建灵活适配的用户界面》</a></div><div class="post-title read"><a href="/blog/2020-08-23-issues-api/">更早一篇：静态博客使用 Issues API 动态发布友链、书签</a></div></section></div><div class="related-posts-wrap"><div class="related_posts"><section class="header"><div class="title cap cyan">您可能感兴趣的文章</div></section><section class="body"><div class="related-posts"><a class="item" href="/blog/2019-07-23-heartmate/" title="心率管家 App 的设计与开发流程" rel="bookmark "><div class="img"><img src="https://7.dusays.com/2021/02/17/b1ceb7fe07147.webp" class="lazyload" data-srcset="https://7.dusays.com/2021/02/17/b1ceb7fe07147.webp" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></div><span class="title">心率管家 App 的设计与开发流程</span><span class="excerpt">近期开发并上架了新版心率管家 App（仅 iOS 端），专业版不定期限免，欢迎下载体验。本文将从设计、开发、上架等每个步骤...</span></a><a class="item" href="/blog/2019-10-06-ios-apple-watch/" title="苹果设计开发加速器《创建卓越的 Apple Watch 体验》活动体验" rel="bookmark "><div class="img"><img src="https://7.dusays.com/2021/02/17/a90e5bed35088.jpg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/17/a90e5bed35088.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></div><span class="title">苹果设计开发加速器《创建卓越的 Apple Watch 体验》活动体验</span><span class="excerpt">9月26号收到了苹果的一活动邀请邮件《创建卓越的 Apple Watch 体验》，活动地点是：Design and Dev...</span></a><a class="item" href="/blog/2020-11-19-ios-layout/" title="苹果线上活动《为 iPhone 和 iPad 搭建灵活适配的用户界面》" rel="bookmark "><div class="img"><img src="https://7.dusays.com/2021/02/17/255b997104e34.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/17/255b997104e34.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></div><span class="title">苹果线上活动《为 iPhone 和 iPad 搭建灵活适配的用户界面》</span><span class="excerpt">受疫情影响，今年设计开发加速器活动改为线上形式，本次参与的活动课题是《为 iPhone 和 iPad 搭建灵活适配的用户界...</span></a><a class="item" href="/blog/2020-08-23-issues-api/" title="静态博客使用 Issues API 动态发布友链、书签" rel="bookmark "><div class="img"><img src="https://7.dusays.com/2021/02/17/7a260660ad226.svg" class="lazyload" data-srcset="https://7.dusays.com/2021/02/17/7a260660ad226.svg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></div><span class="title">静态博客使用 Issues API 动态发布友链、书签</span><span class="excerpt">由于发布 issue 的成本远远低于发布一次博客更新（即便是使用了持续集成），可以用 issue 来简化每个独立博客都必备...</span></a></div></section></div></div><article class="comments-wrap" id="comments"><div class="cmt-title cap cyan">快来参与讨论吧</div><div class="cmt-body utterances"><div id="utterances"></div></div></article><footer class="page-footer"><div><hr><p>除非特别说明，本站采用 CC BY SA 4.0 许可协议。</p><p>本站由 <a href="https://xaoxuu.com/">xaoxuu</a> 创建，使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 作为主题，您可以在 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/site-source">GitHub</a> 找到本站源码。</p></div></footer><div class="float-panel mobile-only" style="display:none"><button type="button" class="sidebar-toggle mobile" onclick="toggleSidebar()"><svg class="icon" viewBox="0 0 1228 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2849"><path d="M0 0m97.390199 0 973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.3902l-973.901995 0q-97.390199 0-97.390199-97.3902l0 0q0-97.390199 97.390199-97.390199Z" p-id="2850"></path><path d="M0 389.560798m97.390199 0 973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.3902l-973.901995 0q-97.390199 0-97.390199-97.3902l0 0q0-97.390199 97.390199-97.390199Z" p-id="2851"></path><path d="M0 779.121596m97.390199 0 973.901995 0q97.390199 0 97.390199 97.390199l0 0q0 97.390199-97.390199 97.390199l-973.901995 0q-97.390199 0-97.390199-97.390199l0 0q0-97.390199 97.390199-97.390199Z" p-id="2852"></path></svg></button></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="/js/main.js" async></script><script defer="defer" src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazyload",threshold:0},window.addEventListener("LazyLoad::Initialized",(function(n){window.lazyLoadInstance=n.detail.instance}),!1),document.addEventListener("DOMContentLoaded",(function(){lazyLoadInstance.update()}))</script><script>function loadSwiper(){0!=$(".md").find(".swiper-container").length&&(loadCSS("https://unpkg.com/swiper/swiper-bundle.min.css"),loadScript("https://unpkg.com/swiper/swiper-bundle.min.js",()=>{new Swiper(".swiper-container",{slidesPerView:"auto",spaceBetween:8,centeredSlides:!0,zoom:!0,pagination:{el:".swiper-pagination",clickable:!0},autoplay:{delay:5e3,disableOnInteraction:!1},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})}))}$((function(){loadSwiper()}))</script><script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.7/dist/scrollreveal.min.js"></script><script type="text/javascript">ScrollReveal().reveal("body .reveal",{distance:"16px",duration:"800",interval:"80",scale:"1",easing:"ease-out"})</script><script>function pjax_utterances(){document.getElementById("utterances")&&setTimeout((function(){var t=setInterval((function(){var e=document.getElementById("utterances");if(!e)return;clearInterval(t);try{e.innerHTML=""}catch(t){}var n=document.createElement("script");n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("repo","xaoxuu/blog-comments");n.setAttribute("issue-term","pathname"),n.setAttribute("theme","github-light"),n.setAttribute("label","✨💬✨"),n.setAttribute("crossorigin","anonymous"),e.appendChild(n)}),200)}))}pjax_utterances()</script><script>function loadIssuesJS(){null!=document.getElementById("issues-api")&&loadScript("/js/issues.js")}$((function(){loadIssuesJS()}))</script></body></html>